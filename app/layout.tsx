'use client'

import { createBrowserSupabaseClient } from '@supabase/auth-helpers-nextjs'
import { SessionContextProvider } from '@supabase/auth-helpers-react'
import clsx from 'clsx'
import Feedback from 'components/Feedback'
import DashboardDesktopSidebar from 'components/Sidebar/DashboardDesktopSidebar'
import DashboardMobileSidebar from 'components/Sidebar/DashboardMobileSidebar'
import StarUs from 'components/StarUs'
import { clientCreds } from 'db/credentials'
import { Database } from 'db/supabase'
import { List, Menu } from 'lucide-react'
import { Inter } from 'next/font/google'
import router, { useParams, usePathname } from 'next/navigation'
import Script from 'next/script'
import { usePostHog } from 'posthog-js/react'
import { ReactNode, useState } from 'react'
import 'styles/global.css'
import * as gtag from '../utils/gtag'


const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
})

// export const metadata = {
//   title: 'Next.js',
//   description: 'Generated by Next.js',
// }

interface Props {
  children: ReactNode
}

export default function RootLayout({
  children,
}: Props) {
  const supabaseClient = createBrowserSupabaseClient<Database>(clientCreds)
  const posthog = usePostHog()
  const urlParams = useParams()
  const pathname = usePathname()
  const [isSidebarOpen, setIsSidebarOpen] = useState(false)

  const [distinctID, setDistinctID] = useState<string>()

  async function signOut() {
    await supabaseClient.auth.signOut()
    posthog?.reset(true)
    router.redirect('/sign')
  }

  const view = process.env.NEXT_PUBLIC_SHOW_UPLOADED_LOGS === '1'
  const showView = urlParams && urlParams['view'] === 'logs' ? 'logs' : view

  const navigation = [
    {
      name: showView === 'logs' ? 'Agent Logs' : 'Agent Deployments',
      icon: List,
    },
  ]

  return (
    <SessionContextProvider
      supabaseClient={supabaseClient}
    >
      <html lang="en">
        <body suppressHydrationWarning={true}>
          <Script id="google-analytics">
            {`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', '${gtag.GA_TRACKING_ID}', {
            page_path: window.location.pathname,
            ${distinctID ? `user_id: ${distinctID}` : ''}
          });
        `}
          </Script>
          <Script
            src={`https://www.googletagmanager.com/gtag/js?id=${gtag.GA_TRACKING_ID}`}
          />
          {(pathname && pathname.startsWith('/agent') || pathname && pathname.startsWith('/sign'))
            ?
            <div className={clsx(
              inter.variable,
              'font-sans',
              'flex',
              'h-full',
              'w-full',
              'flex-1',
              'flex-col',
              'overflow-hidden',
            )}>
              {children}
            </div>
            :
            <>
              <style jsx global>
                {`
        :root {
          --font-inter: ${inter.variable};
        }
        `}
              </style>
              <div className={clsx(
                'font-sans',
                'flex-1',
                'flex',
                'items-start',
                'justify-start',
                'p-2',
                'h-full',
                'w-full',
                'overflow-hidden',
              )}>
                <DashboardMobileSidebar
                  isSidebarOpen={isSidebarOpen}
                  onSetSidebarOpen={setIsSidebarOpen}
                  onSignOut={signOut}
                  navigation={navigation}
                />
                <DashboardDesktopSidebar
                  onSignOut={signOut}
                  navigation={navigation}
                />

                <div className="flex flex-col flex-1 self-stretch overflow-hidden">
                  {/* Mobile menu icon */}
                  <div className="rounded-md xl:hidden sticky top-0 z-40 flex justify-between h-16 shrink-0 items-center gap-x-6 border border-white/5 bg-gray-900 px-4 shadow-sm sm:px-6 lg:px-8">
                    <button
                      type="button"
                      className="-m-2.5 p-2.5 text-white xl:hidden"
                      onClick={() => setIsSidebarOpen(true)}
                    >
                      <span className="sr-only">Open sidebar</span>
                      <Menu aria-hidden="true" />
                    </button>

                    <div className="xl:hidden flex space-x-4">
                      <StarUs />
                      <Feedback />
                    </div>
                  </div>

                  {/* Header` */}
                  <div className="hidden xl:flex px-4 py-2 border border-white/5 justify-end bg-gray-900 rounded-md">
                    <div className="flex justify-end space-x-4">
                      <StarUs />
                      <Feedback />
                    </div>
                  </div>

                  <div className="mt-1 flex-1 flex flex-col self-stretch overflow-auto bg-gray-900 rounded-md border border-white/5">
                    {children}
                  </div>
                </div>
              </div>
            </>
          }
        </body>
      </html>
    </SessionContextProvider>
  )
}
